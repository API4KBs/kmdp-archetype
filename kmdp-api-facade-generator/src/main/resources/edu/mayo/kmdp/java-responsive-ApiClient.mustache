package {{invokerPackage}};


{{#imports}}import {{import}};
{{/imports}}

{{^fullJavaUtil}}
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.stream.Collectors;
{{/fullJavaUtil}}

import java.lang.reflect.Field;

import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.MediaType;
import org.springframework.http.RequestEntity;
import org.springframework.http.RequestEntity.BodyBuilder;
import org.springframework.http.ResponseEntity;
import org.springframework.util.MultiValueMap;
import org.springframework.util.ReflectionUtils;
import org.springframework.web.util.UriComponentsBuilder;
import org.springframework.web.client.RestClientException;
import org.springframework.web.client.RestTemplate;

import {{invokerPackage}}.auth.Authentication;


import static edu.mayo.kmdp.util.ws.JsonRestWSUtils.enableFHIR;
import edu.mayo.kmdp.util.ws.JsonRestWSUtils.WithFHIR;

public class ResponsiveApiClient extends ApiClient {

  private RestTemplate restTemplate;

  public ResponsiveApiClient(RestTemplate restTemplate) {
    super(restTemplate);
    this.restTemplate = restTemplate;
  }

  /**
   * Invoke API by sending HTTP request with the given options.
   *
   * @param <T> the return type to use
   * @param path The sub-path of the HTTP URL
   * @param method The request method
   * @param queryParams The query parameters
   * @param body The request body object
   * @param headerParams The header parameters
   * @param formParams The form parameters
   * @param accept The request's Accept header
   * @param contentType The request's Content-Type header
   * @param authNames The authentications to apply
   * @param returnType The return type into which to deserialize the response
   * @return The response body in chosen type
   */
  public <T> ResponseEntity<T> callAPI(String path, HttpMethod method,
      MultiValueMap<String, String> queryParams, Object body, HttpHeaders headerParams,
      MultiValueMap<String, Object> formParams, List<MediaType> accept, MediaType contentType,
      String[] authNames, ParameterizedTypeReference<T> returnType) throws RestClientException {

    for (String authName : authNames) {
      Authentication auth = getAuthentications().get(authName);
      if (auth != null) {
        auth.applyToParams(queryParams, headerParams);
      }
    }

    final UriComponentsBuilder builder = UriComponentsBuilder.fromHttpUrl(getBasePath()).path(path);
    if (queryParams != null) {
      builder.queryParams(queryParams);
    }

    final BodyBuilder requestBuilder = RequestEntity.method(method, builder.build().toUri());
    if (accept != null) {
      requestBuilder.accept(accept.toArray(new MediaType[accept.size()]));
    }
    if (contentType != null) {
      requestBuilder.contentType(contentType);
    }

    addHeadersToRequest(headerParams, requestBuilder);
    //addHeadersToRequest(defaultHeaders, requestBuilder);

    RequestEntity<Object> requestEntity = requestBuilder
        .body(selectBody(body, formParams, contentType));

    ResponseEntity<T> responseEntity = this.restTemplate.exchange(requestEntity, returnType);
    return responseEntity;
  }

}

